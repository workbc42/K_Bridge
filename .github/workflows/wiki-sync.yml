name: Sync docs to wiki

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - '.github/workflows/wiki-sync.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-wiki:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Sync docs to wiki
        env:
          GH_TOKEN: ${{ secrets.WIKI_SYNC_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "Missing WIKI_SYNC_TOKEN secret."
            exit 1
          fi

          REPO="${GITHUB_REPOSITORY}"
          WIKI_REPO="https://x-access-token:${GH_TOKEN}@github.com/${REPO}.wiki.git"

          git clone "$WIKI_REPO" wiki
          IGNORE_FILE="docs/.wikiignore"
          RSYNC_EXCLUDES="--exclude .git"
          if [ -f "$IGNORE_FILE" ]; then
            RSYNC_EXCLUDES="$RSYNC_EXCLUDES --exclude-from $IGNORE_FILE"
          fi

          # Keep wiki repo metadata; rsync deletes anything not excluded.
          rsync -av --delete $RSYNC_EXCLUDES docs/ wiki/

          # Home.md from docs/README.md
          if [ -f docs/README.md ]; then
            cp docs/README.md wiki/Home.md
          fi

          # _Sidebar.md from docs tree
          tmp_api="/tmp/sidebar_api.txt"
          tmp_db="/tmp/sidebar_db.txt"
          tmp_setup="/tmp/sidebar_setup.txt"
          tmp_general="/tmp/sidebar_general.txt"
          : > "$tmp_api"
          : > "$tmp_db"
          : > "$tmp_setup"
          : > "$tmp_general"

          declare -A added

          is_ignored() {
            if [ -f "$IGNORE_FILE" ] && grep -Fxq "$1" "$IGNORE_FILE"; then
              return 0
            fi
            return 1
          }

          add_link() {
            local file="$1"
            local rel="${file#docs/}"

            if [ "$rel" = "README.md" ]; then
              return 0
            fi

            if is_ignored "$rel"; then
              return 0
            fi

            if [ -n "${added[$rel]}" ]; then
              return 0
            fi

            first_line="$(head -n 1 "$file")"
            title="$(echo "$first_line" | sed -E 's/^#+[[:space:]]*//')"
            if [ -z "$title" ]; then
              title="$(basename "$rel" .md)"
            fi

            link="${rel%.md}"
            link="${link// /%20}"

            section="general"
            case "$rel" in
              API* ) section="api" ;;
              DB* ) section="db" ;;
              SETUP* | DEPLOYMENT* ) section="setup" ;;
            esac

            case "$section" in
              api ) echo "- [${title}](${link})" >> "$tmp_api" ;;
              db ) echo "- [${title}](${link})" >> "$tmp_db" ;;
              setup ) echo "- [${title}](${link})" >> "$tmp_setup" ;;
              * ) echo "- [${title}](${link})" >> "$tmp_general" ;;
            esac

            added[$rel]=1
          }

          # Preferred ordering inside sections.
          add_link "docs/API.md"
          add_link "docs/API_ROUTES.md"
          add_link "docs/DATABASE.md"
          add_link "docs/DB_SCHEMA.md"
          add_link "docs/SETUP.md"
          add_link "docs/DEPLOYMENT.md"

          find docs -type f -name '*.md' -print0 | sort -z | while IFS= read -r -d '' file; do
            add_link "$file"
          done

          {
            echo "## Docs"
            echo "- [Home](Home)"
            if [ -s "$tmp_api" ]; then
              echo ""
              echo "### API"
              cat "$tmp_api"
            fi
            if [ -s "$tmp_db" ]; then
              echo ""
              echo "### DB"
              cat "$tmp_db"
            fi
            if [ -s "$tmp_setup" ]; then
              echo ""
              echo "### Setup"
              cat "$tmp_setup"
            fi
            if [ -s "$tmp_general" ]; then
              echo ""
              echo "### General"
              cat "$tmp_general"
            fi
          } > wiki/_Sidebar.md

          # Build Home.md with an index section.
          if [ -f docs/README.md ]; then
            {
              cat docs/README.md
              echo ""
              echo "## Wiki Index"
              echo "- [Home](Home)"
              if [ -s "$tmp_api" ]; then
                echo ""
                echo "### API"
                cat "$tmp_api"
              fi
              if [ -s "$tmp_db" ]; then
                echo ""
                echo "### DB"
                cat "$tmp_db"
              fi
              if [ -s "$tmp_setup" ]; then
                echo ""
                echo "### Setup"
                cat "$tmp_setup"
              fi
              if [ -s "$tmp_general" ]; then
                echo ""
                echo "### General"
                cat "$tmp_general"
              fi
            } > wiki/Home.md
          fi

          cd wiki
          if git status --porcelain | grep -q .; then
            git add .
            git -c user.name='wiki-sync-bot' -c user.email='actions@github.com' commit -m "Sync docs to wiki"
            git push
          else
            echo "No changes to sync."
          fi
