name: Sync docs to wiki

on:
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - '.github/workflows/wiki-sync.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sync-wiki:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Sync docs to wiki
        env:
          GH_TOKEN: ${{ secrets.WIKI_SYNC_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "Missing WIKI_SYNC_TOKEN secret."
            exit 1
          fi

          REPO="${GITHUB_REPOSITORY}"
          WIKI_REPO="https://x-access-token:${GH_TOKEN}@github.com/${REPO}.wiki.git"

          git clone "$WIKI_REPO" wiki
          rm -rf wiki/*
          rsync -av --delete docs/ wiki/

          # Home.md from docs/README.md
          if [ -f docs/README.md ]; then
            cp docs/README.md wiki/Home.md
          fi

          # _Sidebar.md from docs tree
          tmp_api="/tmp/sidebar_api.txt"
          tmp_db="/tmp/sidebar_db.txt"
          tmp_setup="/tmp/sidebar_setup.txt"
          tmp_general="/tmp/sidebar_general.txt"
          : > "$tmp_api"
          : > "$tmp_db"
          : > "$tmp_setup"
          : > "$tmp_general"

          find docs -type f -name '*.md' -print0 | sort -z | while IFS= read -r -d '' file; do
            rel="${file#docs/}"
            if [ "$rel" = "README.md" ]; then
              continue
            fi

            first_line="$(head -n 1 "$file")"
            title="$(echo "$first_line" | sed -E 's/^#+[[:space:]]*//')"
            if [ -z "$title" ]; then
              title="$(basename "$rel" .md)"
            fi

            link="${rel%.md}"
            link="${link// /%20}"

            section="general"
            case "$rel" in
              API* ) section="api" ;;
              DB* ) section="db" ;;
              SETUP* | DEPLOYMENT* ) section="setup" ;;
            esac

            case "$section" in
              api ) echo "- [${title}](${link})" >> "$tmp_api" ;;
              db ) echo "- [${title}](${link})" >> "$tmp_db" ;;
              setup ) echo "- [${title}](${link})" >> "$tmp_setup" ;;
              * ) echo "- [${title}](${link})" >> "$tmp_general" ;;
            esac
          done

          {
            echo "## Docs"
            echo "- [Home](Home)"
            if [ -s "$tmp_api" ]; then
              echo ""
              echo "### API"
              cat "$tmp_api"
            fi
            if [ -s "$tmp_db" ]; then
              echo ""
              echo "### DB"
              cat "$tmp_db"
            fi
            if [ -s "$tmp_setup" ]; then
              echo ""
              echo "### Setup"
              cat "$tmp_setup"
            fi
            if [ -s "$tmp_general" ]; then
              echo ""
              echo "### General"
              cat "$tmp_general"
            fi
          } > wiki/_Sidebar.md

          cd wiki
          if git status --porcelain | grep -q .; then
            git add .
            git -c user.name='wiki-sync-bot' -c user.email='actions@github.com' commit -m "Sync docs to wiki"
            git push
          else
            echo "No changes to sync."
          fi
